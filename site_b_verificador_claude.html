<!DOCTYPE html>
<html>
<head>
  <title>Site B - Verificador</title>
</head>
<body>
  <h1>üîç Site B - Verificando login do Site A...</h1>
  <div id="resultado">‚è≥ Aguardando resposta...</div>
  
  <div style="margin-top: 20px;">
    <button id="verificarAgain">üîÑ Verificar Novamente</button>
    <button id="reloadIframe">üîÑ Recarregar Site A</button>
    <button id="forceSync">üî¨ For√ßar Sincroniza√ß√£o Deep</button>
  </div>

  <iframe id="iframeA" src="https://viocomg.github.io/cursofechadoviolao/site_a_login_claude.html" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 20px;"></iframe>
  
  <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>

  <script>
    const logDiv = document.getElementById('logs');
    
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      logDiv.innerHTML += logMessage + '<br>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    addLog("[Site B] üöÄ Iniciando Site B...");

    const iframe = document.getElementById("iframeA");
    const resultado = document.getElementById("resultado");
    let respostaRecebida = false;
    let siteAReady = false;
    let tentativasEnvio = 0;
    let ultimoStatusRecebido = null;
    const maxTentativas = 5; // Aumentado para dar mais chances

    addLog(`[Site B] üîó URL do iframe: ${iframe.src}`);
    addLog(`[Site B] üåê Origem atual: ${window.location.origin}`);

    // Fun√ß√£o para obter a origem esperada do iframe
    function getIframeOrigin() {
      try {
        const url = new URL(iframe.src, window.location.href);
        return url.origin;
      } catch (error) {
        addLog(`[Site B] ‚ùå Erro ao processar URL do iframe: ${error.message}`);
        return window.location.origin;
      }
    }

    // Listener de mensagens
    window.addEventListener("message", (event) => {
      addLog(`[Site B] üì® Mensagem recebida de: ${event.origin}`);
      addLog(`[Site B] üìÑ Dados da mensagem: ${JSON.stringify(event.data)}`);

      // Valida√ß√£o de origem mais flex√≠vel
      const origemEsperada = getIframeOrigin();
      addLog(`[Site B] üéØ Origem esperada: ${origemEsperada}`);
      
      if (!event.data || typeof event.data !== 'object') {
        addLog("[Site B] ‚ùå Dados da mensagem inv√°lidos");
        return;
      }

      if (event.data.type === "siteAReady") {
        addLog("[Site B] ‚úÖ Site A est√° pronto para comunica√ß√£o!");
        addLog(`[Site B] üë§ Usu√°rio atual no Site A: ${event.data.currentUser ? JSON.stringify(event.data.currentUser) : 'nenhum'}`);
        addLog(`[Site B] üì± Contexto: ${event.data.context || 'n√£o informado'}`);
        
        siteAReady = true;
        
        // Se j√° tem usu√°rio logado, mostra status imediatamente
        if (event.data.currentUser) {
          mostrarStatusLogado(event.data.currentUser, event.data.timestamp, event.data.context);
        }
        
        // Aguarda um pouco mais para sincroniza√ß√£o completa e envia verifica√ß√£o
        setTimeout(() => {
          addLog("[Site B] üîÑ Iniciando verifica√ß√£o ap√≥s siteAReady...");
          enviarVerificacao();
        }, 1500); // Aumentado para 1.5 segundos
        
      } else if (event.data.type === "loginStatus") {
        addLog("[Site B] üìä Status de login recebido");
        respostaRecebida = true;
        ultimoStatusRecebido = event.data;
        
        if (event.data.loggedIn) {
          addLog(`[Site B] ‚úÖ Usu√°rio EST√Å logado no Site A! UID: ${event.data.uid}`);
          addLog(`[Site B] üîç √â an√¥nimo: ${event.data.isAnonymous}`);
          addLog(`[Site B] üì± Contexto: ${event.data.context || 'n√£o informado'}`);
          addLog(`[Site B] üî¨ M√©todo de sync: ${event.data.syncMethod || 'padr√£o'}`);
          
          mostrarStatusLogado({
            uid: event.data.uid,
            isAnonymous: event.data.isAnonymous
          }, event.data.timestamp, event.data.context, event.data.syncMethod);
        } else {
          addLog("[Site B] ‚ùå Usu√°rio N√ÉO est√° logado no Site A");
          mostrarStatusDeslogado(event.data.timestamp, event.data.context);
        }
      } else {
        addLog(`[Site B] ‚ùì Tipo de mensagem desconhecido: ${event.data.type}`);
      }
    });

    function mostrarStatusLogado(userInfo, timestamp, context, syncMethod) {
      resultado.innerHTML = `
        <div style="color: green; border: 2px solid green; padding: 10px; border-radius: 5px;">
          ‚úÖ <strong>LOGADO no Site A!</strong><br>
          <small>
            UID: ${userInfo.uid}<br>
            An√¥nimo: ${userInfo.isAnonymous}<br>
            Contexto: ${context || 'n√£o informado'}<br>
            Sync: ${syncMethod || 'padr√£o'}<br>
            Timestamp: ${timestamp}<br>
            Last Auth: ${userInfo.authTime || 'n√£o informado'}
          </small>
        </div>
      `;
    }

    function mostrarStatusDeslogado(timestamp, context) {
      resultado.innerHTML = `
        <div style="color: red; border: 2px solid red; padding: 10px; border-radius: 5px;">
          ‚ùå <strong>N√ÉO LOGADO no Site A</strong><br>
          <small>
            Contexto: ${context || 'n√£o informado'}<br>
            Timestamp: ${timestamp}<br>
            <em>Tente fazer login em uma aba separada do Site A primeiro</em>
          </small>
        </div>
      `;
    }

    function enviarVerificacao() {
      if (!siteAReady) {
        addLog("[Site B] ‚è≥ Site A ainda n√£o est√° pronto");
        return;
      }

      if (tentativasEnvio >= maxTentativas) {
        addLog(`[Site B] ‚ö†Ô∏è M√°ximo de tentativas (${maxTentativas}) atingido`);
        mostrarStatusTimeout();
        return;
      }

      tentativasEnvio++;
      addLog(`[Site B] üì§ Enviando verifica√ß√£o para Site A (tentativa ${tentativasEnvio}/${maxTentativas})`);
      
      const message = { 
        type: "checkLogin",
        timestamp: new Date().toISOString(),
        tentativa: tentativasEnvio,
        forceDeepSync: tentativasEnvio > 2 // For√ßa sync profundo ap√≥s 2 tentativas
      };
      
      const targetOrigin = getIframeOrigin();
      addLog(`[Site B] üéØ Origem de destino: ${targetOrigin}`);
      
      try {
        if (!iframe.contentWindow) {
          addLog("[Site B] ‚ùå ContentWindow do iframe n√£o dispon√≠vel");
          return;
        }
        
        iframe.contentWindow.postMessage(message, targetOrigin);
        addLog(`[Site B] ‚úÖ Mensagem enviada com sucesso: ${JSON.stringify(message)}`);
        
        respostaRecebida = false;
        
        // Timeout progressivo - mais tempo para tentativas posteriores
        const timeoutDelay = Math.min(5000 + (tentativasEnvio * 2000), 12000);
        addLog(`[Site B] ‚è∞ Timeout configurado para ${timeoutDelay/1000}s`);
        
        setTimeout(() => {
          if (!respostaRecebida) {
            addLog(`[Site B] ‚è∞ Timeout na tentativa ${tentativasEnvio}`);
            
            if (tentativasEnvio < maxTentativas) {
              addLog("[Site B] üîÑ Tentando novamente em 3 segundos...");
              setTimeout(() => {
                enviarVerificacao();
              }, 3000);
            } else {
              addLog("[Site B] ‚ùå Todas as tentativas falharam");
              mostrarStatusTimeout();
            }
          }
        }, timeoutDelay);
        
      } catch (error) {
        addLog(`[Site B] ‚ùå Erro ao enviar mensagem: ${error.message}`);
      }
    }

    function mostrarStatusTimeout() {
      resultado.innerHTML = `
        <div style="color: orange; border: 2px solid orange; padding: 10px; border-radius: 5px;">
          ‚ö†Ô∏è <strong>SEM RESPOSTA do Site A</strong><br>
          <small>
            Tentativas: ${tentativasEnvio}/${maxTentativas}<br>
            Poss√≠veis causas:<br>
            ‚Ä¢ Site A ainda carregando<br>
            ‚Ä¢ Problemas de sincroniza√ß√£o do Firebase<br>
            ‚Ä¢ Login foi feito em contexto diferente<br>
            <br>
            <em>Tente: Recarregar iframe, Verificar novamente, ou Fazer login diretamente no iframe</em>
          </small>
        </div>
      `;
    }

    function forcarSincronizacaoDeep() {
      addLog("[Site B] üî¨ For√ßando sincroniza√ß√£o deep no Site A...");
      
      const message = { 
        type: "forceDeepSync",
        timestamp: new Date().toISOString()
      };
      
      try {
        iframe.contentWindow.postMessage(message, getIframeOrigin());
        addLog("[Site B] ‚úÖ Comando de sincroniza√ß√£o deep enviado");
        
        // Aguarda um pouco e ent√£o verifica
        setTimeout(() => {
          tentativasEnvio = 0; // Reset tentativas
          enviarVerificacao();
        }, 2000);
      } catch (error) {
        addLog(`[Site B] ‚ùå Erro ao enviar comando deep sync: ${error.message}`);
      }
    }

    // Quando o iframe carregar
    iframe.onload = () => {
      addLog("[Site B] üì± Iframe carregado");
      addLog(`[Site B] üîó URL final do iframe: ${iframe.contentWindow?.location?.href || 'n√£o acess√≠vel'}`);
      
      // Reset das vari√°veis
      siteAReady = false;
      respostaRecebida = false;
      tentativasEnvio = 0;
      ultimoStatusRecebido = null;
      
      // Atualiza status
      resultado.innerHTML = "‚è≥ Aguardando Site A carregar...";
      
      // Fallback: se n√£o receber siteAReady em 8 segundos, for√ßa tentativa
      setTimeout(() => {
        if (!siteAReady) {
          addLog("[Site B] ‚è∞ Timeout aguardando siteAReady, for√ßando tentativa...");
          siteAReady = true;
          enviarVerificacao();
        }
      }, 8000); // Aumentado para 8 segundos
    };

    // Event listeners dos bot√µes
    document.getElementById("verificarAgain").addEventListener("click", () => {
      addLog("[Site B] üîÑ Verifica√ß√£o manual solicitada");
      tentativasEnvio = 0;
      resultado.innerHTML = "‚è≥ Verificando novamente...";
      enviarVerificacao();
    });

    document.getElementById("reloadIframe").addEventListener("click", () => {
      addLog("[Site B] üîÑ Recarregando iframe do Site A");
      resultado.innerHTML = "‚è≥ Recarregando Site A...";
      iframe.src = iframe.src;
    });

    document.getElementById("forceSync").addEventListener("click", () => {
      addLog("[Site B] üî¨ For√ßando sincroniza√ß√£o deep solicitada pelo usu√°rio");
      forcarSincronizacaoDeep();
    });

    // NOVA FUNCIONALIDADE: Verifica√ß√£o peri√≥dica autom√°tica
    let verificacaoPeriodicaAtiva = false;
    
    function iniciarVerificacaoPeriorica() {
      if (verificacaoPeriodicaAtiva) return;
      
      verificacaoPeriodicaAtiva = true;
      addLog("[Site B] ‚è∞ Iniciando verifica√ß√£o peri√≥dica autom√°tica...");
      
      const intervalo = setInterval(() => {
        if (!siteAReady) {
          addLog("[Site B] ‚è∞ Verifica√ß√£o peri√≥dica: Site A n√£o est√° pronto");
          return;
        }
        
        // S√≥ faz verifica√ß√£o peri√≥dica se n√£o h√° status recente
        const agora = new Date();
        const ultimaVerificacao = ultimoStatusRecebido ? new Date(ultimoStatusRecebido.timestamp) : null;
        
        if (!ultimaVerificacao || (agora - ultimaVerificacao) > 30000) { // 30 segundos
          addLog("[Site B] ‚è∞ Verifica√ß√£o peri√≥dica: executando check autom√°tico");
          tentativasEnvio = 0;
          enviarVerificacao();
        }
      }, 15000); // A cada 15 segundos
      
      // Para a verifica√ß√£o peri√≥dica ap√≥s 5 minutos
      setTimeout(() => {
        clearInterval(intervalo);
        verificacaoPeriodicaAtiva = false;
        addLog("[Site B] ‚è∞ Verifica√ß√£o peri√≥dica autom√°tica finalizada");
      }, 300000); // 5 minutos
    }

    // Inicia verifica√ß√£o peri√≥dica ap√≥s um tempo
    setTimeout(() => {
      iniciarVerificacaoPeriorica();
    }, 10000); // Ap√≥s 10 segundos da carga da p√°gina

    // NOVA FUNCIONALIDADE: Detectar mudan√ßas na aba do Site A
    function monitorarMudancasAbaSiteA() {
      addLog("[Site B] üëÅÔ∏è Iniciando monitoramento de mudan√ßas na aba do Site A...");
      
      // Tenta abrir uma refer√™ncia para o Site A em nova aba (se n√£o existir)
      // Isso ajuda a detectar quando h√° login em outra aba
      window.addEventListener('focus', () => {
        addLog("[Site B] üëÅÔ∏è Janela focada - verificando poss√≠veis mudan√ßas de login");
        setTimeout(() => {
          if (siteAReady) {
            tentativasEnvio = 0;
            enviarVerificacao();
          }
        }, 1000);
      });
      
      // Detectar mudan√ßas de storage (caso o Firebase use localStorage para sync)
      window.addEventListener('storage', (e) => {
        if (e.key && e.key.includes('firebase')) {
          addLog(`[Site B] üíæ Mudan√ßa detectada no storage Firebase: ${e.key}`);
          setTimeout(() => {
            if (siteAReady) {
              addLog("[Site B] üîÑ Verificando login ap√≥s mudan√ßa de storage...");
              tentativasEnvio = 0;
              enviarVerificacao();
            }
          }, 2000);
        }
      });
    }

    // Inicia monitoramento
    monitorarMudancasAbaSiteA();

    // NOVA FUNCIONALIDADE: Status visual aprimorado
    function criarIndicadorStatus() {
      const indicador = document.createElement('div');
      indicador.id = 'statusIndicator';
      indicador.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
        background: #f0f0f0;
        border: 2px solid #ccc;
        min-width: 150px;
        text-align: center;
      `;
      indicador.innerHTML = 'üîÑ Carregando...';
      document.body.appendChild(indicador);
      
      return indicador;
    }

    const statusIndicador = criarIndicadorStatus();

    // Atualizar indicador baseado no estado
    function atualizarIndicadorStatus(estado, detalhes = '') {
      const estilos = {
        carregando: { bg: '#fff3cd', border: '#ffeaa7', text: 'üîÑ Carregando...' },
        pronto: { bg: '#d4edda', border: '#c3e6cb', text: '‚úÖ Site A Pronto' },
        logado: { bg: '#d1ecf1', border: '#bee5eb', text: 'üîê Usu√°rio Logado' },
        deslogado: { bg: '#f8d7da', border: '#f5c6cb', text: '‚ùå N√£o Logado' },
        erro: { bg: '#f8d7da', border: '#f5c6cb', text: '‚ö†Ô∏è Erro/Timeout' }
      };
      
      const estilo = estilos[estado] || estilos.carregando;
      statusIndicador.style.background = estilo.bg;
      statusIndicador.style.borderColor = estilo.border;
      statusIndicador.innerHTML = estilo.text + (detalhes ? `<br><small>${detalhes}</small>` : '');
    }

    // Interceptar mudan√ßas de resultado para atualizar indicador
    const resultadoOriginal = resultado.innerHTML;
    const observer = new MutationObserver(() => {
      const conteudo = resultado.innerHTML;
      if (conteudo.includes('LOGADO no Site A')) {
        atualizarIndicadorStatus('logado');
      } else if (conteudo.includes('N√ÉO LOGADO')) {
        atualizarIndicadorStatus('deslogado');
      } else if (conteudo.includes('SEM RESPOSTA')) {
        atualizarIndicadorStatus('erro');
      } else if (conteudo.includes('Aguardando')) {
        atualizarIndicadorStatus('carregando');
      }
    });
    
    observer.observe(resultado, { childList: true, subtree: true });

    // Log quando a p√°gina termina de carregar
    window.addEventListener('load', () => {
      addLog("[Site B] üìÑ P√°gina Site B totalmente carregada");
      atualizarIndicadorStatus('carregando');
    });

    // Log de erros gerais
    window.addEventListener('error', (event) => {
      addLog(`[Site B] üí• Erro JavaScript: ${event.message} em ${event.filename}:${event.lineno}`);
    });

    // NOVA FUNCIONALIDADE: Bot√£o para abrir Site A em nova aba
    const abrirSiteABtn = document.createElement('button');
    abrirSiteABtn.textContent = 'üîó Abrir Site A em Nova Aba';
    abrirSiteABtn.style.marginLeft = '10px';
    abrirSiteABtn.addEventListener('click', () => {
      const urlSiteA = iframe.src;
      addLog(`[Site B] üîó Abrindo Site A em nova aba: ${urlSiteA}`);
      window.open(urlSiteA, '_blank');
    });
    
    document.querySelector('div[style*="margin-top: 20px"]').appendChild(abrirSiteABtn);

    // Log inicial
    addLog("[Site B] ‚úÖ Sistema de logs iniciado");
    addLog("[Site B] üîß Funcionalidades extras ativadas:");
    addLog("[Site B]   ‚Ä¢ Verifica√ß√£o peri√≥dica autom√°tica");
    addLog("[Site B]   ‚Ä¢ Monitoramento de mudan√ßas de aba");
    addLog("[Site B]   ‚Ä¢ Indicador visual de status");
    addLog("[Site B]   ‚Ä¢ Sincroniza√ß√£o deep sob demanda");
