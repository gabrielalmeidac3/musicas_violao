<!DOCTYPE html>
<html>
<head>
  <title>Site B - Verificador</title>
</head>
<body>
  <h1>üîç Site B - Verificando login do Site A...</h1>
  <div id="resultado">‚è≥ Aguardando resposta...</div>

  <iframe id="iframeA" src="https://viocomg.github.io/cursofechadoviolao/site_a_login.html" style="display:none;"></iframe>

  <script>
    console.log("[Site B] üöÄ Iniciando verifica√ß√£o...");

    const iframe = document.getElementById("iframeA");
    const resultado = document.getElementById("resultado");
    let respostaRecebida = false;
    let siteAReady = false;

    // Escuta respostas do Site A
    window.addEventListener("message", (event) => {
      console.log("[Site B] üì© Mensagem recebida de:", event.origin, event.data);

      // Confere se vem do dom√≠nio esperado
      const origemEsperada = iframe.src.split("/").slice(0, 3).join("/");
      if (event.origin !== origemEsperada) {
        console.warn("[Site B] ‚ö†Ô∏è Origem inesperada da mensagem:", event.origin);
        return;
      }

      if (event.data.type === "siteAReady") {
        console.log("[Site B] ‚úÖ Site A est√° pronto!");
        siteAReady = true;
        enviarVerificacao();
      } else if (event.data.type === "loginStatus") {
        respostaRecebida = true;
        if (event.data.loggedIn) {
          console.log("[Site B] ‚úÖ Usu√°rio est√° logado no Site A! UID:", event.data.uid);
          resultado.innerText = "‚úÖ Logado no Site A!";
          resultado.style.color = "green";
        } else {
          console.log("[Site B] ‚ùå Usu√°rio N√ÉO est√° logado no Site A.");
          resultado.innerText = "‚ùå N√£o logado no Site A.";
          resultado.style.color = "red";
        }
      }
    });

    function enviarVerificacao() {
      if (!siteAReady) {
        console.log("[Site B] ‚è≥ Aguardando Site A ficar pronto...");
        return;
      }

      console.log("[Site B] üì§ Enviando verifica√ß√£o para Site A...");
      const message = { type: "checkLogin" };
      const targetOrigin = iframe.src.split("/").slice(0, 3).join("/");
      iframe.contentWindow.postMessage(message, targetOrigin);
      console.log("[Site B] üì§ Mensagem enviada:", message, "para", targetOrigin);

      // Define timeout para verificar se a resposta vem
      setTimeout(() => {
        if (!respostaRecebida) {
          console.warn("[Site B] ‚è∞ Tempo limite atingido. Nenhuma resposta do Site A.");
          resultado.innerText = "‚ö†Ô∏è Sem resposta do Site A.";
          resultado.style.color = "orange";
        }
      }, 8000); // 8 segundos
    }

    // Quando o iframe carregar
    iframe.onload = () => {
      console.log("[Site B] ‚úÖ Iframe carregado. Aguardando Site A ficar pronto...");
      
      // Fallback: se n√£o receber siteAReady em 3 segundos, tenta mesmo assim
      setTimeout(() => {
        if (!siteAReady) {
          console.log("[Site B] ‚ö†Ô∏è Timeout aguardando siteAReady, tentando mesmo assim...");
          siteAReady = true;
          enviarVerificacao();
        }
      }, 3000);
    };
  </script>
</body>
</html>
