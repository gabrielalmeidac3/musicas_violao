<!DOCTYPE html>
<html>
<head>
  <title>Site B - Verificador</title>
</head>
<body>
  <h1>ğŸ” Site B - Verificando login do Site A...</h1>
  <div id="resultado">â³ Aguardando resposta...</div>
  
  <div style="margin-top: 20px;">
    <button id="verificarAgain">ğŸ”„ Verificar Novamente</button>
    <button id="reloadIframe">ğŸ”„ Recarregar Site A</button>
  </div>

  <iframe id="iframeA" src="site_a_login_claude.html" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 20px;"></iframe>
  <!-- 
  IMPORTANTE: Certifique-se de que o src="" acima aponta para o arquivo Site A CORRETO!
  Deve ser o mesmo arquivo que vocÃª estÃ¡ testando diretamente.
  Se o arquivo se chama "site_a_login_fixed.html", mude o src acima.
  -->
  
  <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>

  <script>
    const logDiv = document.getElementById('logs');
    
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage);
      logDiv.innerHTML += logMessage + '<br>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    addLog("[Site B] ğŸš€ Iniciando Site B...");

    const iframe = document.getElementById("iframeA");
    const resultado = document.getElementById("resultado");
    let respostaRecebida = false;
    let siteAReady = false;
    let tentativasEnvio = 0;
    const maxTentativas = 3;

    addLog(`[Site B] ğŸ”— URL do iframe: ${iframe.src}`);
    addLog(`[Site B] ğŸŒ Origem atual: ${window.location.origin}`);

    // FunÃ§Ã£o para obter a origem esperada do iframe
    function getIframeOrigin() {
      try {
        const url = new URL(iframe.src, window.location.href);
        return url.origin;
      } catch (error) {
        addLog(`[Site B] âŒ Erro ao processar URL do iframe: ${error.message}`);
        return window.location.origin; // fallback para mesma origem
      }
    }

    // Listener de mensagens
    window.addEventListener("message", (event) => {
      addLog(`[Site B] ğŸ“¨ Mensagem recebida de: ${event.origin}`);
      addLog(`[Site B] ğŸ“„ Dados da mensagem: ${JSON.stringify(event.data)}`);

      // ValidaÃ§Ã£o de origem mais flexÃ­vel
      const origemEsperada = getIframeOrigin();
      addLog(`[Site B] ğŸ¯ Origem esperada: ${origemEsperada}`);
      
      // Aceita mensagens da mesma origem ou do iframe
      if (event.origin !== origemEsperada && event.origin !== window.location.origin) {
        addLog(`[Site B] âš ï¸ Origem nÃ£o confiÃ¡vel: ${event.origin} (esperado: ${origemEsperada})`);
        // Mas nÃ£o retorna, vamos processar mesmo assim para debug
      }

      if (!event.data || typeof event.data !== 'object') {
        addLog("[Site B] âŒ Dados da mensagem invÃ¡lidos");
        return;
      }

      if (event.data.type === "siteAReady") {
        addLog("[Site B] âœ… Site A estÃ¡ pronto para comunicaÃ§Ã£o!");
        addLog(`[Site B] ğŸ‘¤ UsuÃ¡rio atual no Site A: ${event.data.currentUser ? JSON.stringify(event.data.currentUser) : 'nenhum'}`);
        
        siteAReady = true;
        
        // Aguarda um pouco e envia verificaÃ§Ã£o
        setTimeout(() => {
          enviarVerificacao();
        }, 500);
        
      } else if (event.data.type === "loginStatus") {
        addLog("[Site B] ğŸ“Š Status de login recebido");
        respostaRecebida = true;
        
        if (event.data.loggedIn) {
          addLog(`[Site B] âœ… UsuÃ¡rio ESTÃ logado no Site A! UID: ${event.data.uid}`);
          addLog(`[Site B] ğŸ” Ã‰ anÃ´nimo: ${event.data.isAnonymous}`);
          addLog(`[Site B] ğŸ“± Contexto: ${event.data.context || 'nÃ£o informado'}`);
          
          resultado.innerHTML = `
            <div style="color: green;">
              âœ… Logado no Site A!<br>
              <small>UID: ${event.data.uid}<br>
              AnÃ´nimo: ${event.data.isAnonymous}<br>
              Contexto: ${event.data.context || 'nÃ£o informado'}<br>
              Timestamp: ${event.data.timestamp}</small>
            </div>
          `;
        } else {
          addLog("[Site B] âŒ UsuÃ¡rio NÃƒO estÃ¡ logado no Site A");
          resultado.innerHTML = `
            <div style="color: red;">
              âŒ NÃ£o logado no Site A<br>
              <small>Timestamp: ${event.data.timestamp}</small>
            </div>
          `;
        }
      } else {
        addLog(`[Site B] â“ Tipo de mensagem desconhecido: ${event.data.type}`);
      }
    });

    function enviarVerificacao() {
      if (!siteAReady) {
        addLog("[Site B] â³ Site A ainda nÃ£o estÃ¡ pronto");
        return;
      }

      if (tentativasEnvio >= maxTentativas) {
        addLog(`[Site B] âš ï¸ MÃ¡ximo de tentativas (${maxTentativas}) atingido`);
        return;
      }

      tentativasEnvio++;
      addLog(`[Site B] ğŸ“¤ Enviando verificaÃ§Ã£o para Site A (tentativa ${tentativasEnvio}/${maxTentativas})`);
      
      const message = { 
        type: "checkLogin",
        timestamp: new Date().toISOString(),
        tentativa: tentativasEnvio
      };
      
      const targetOrigin = getIframeOrigin();
      addLog(`[Site B] ğŸ¯ Origem de destino: ${targetOrigin}`);
      
      try {
        if (!iframe.contentWindow) {
          addLog("[Site B] âŒ ContentWindow do iframe nÃ£o disponÃ­vel");
          return;
        }
        
        iframe.contentWindow.postMessage(message, targetOrigin);
        addLog(`[Site B] âœ… Mensagem enviada com sucesso: ${JSON.stringify(message)}`);
        
        respostaRecebida = false;
        
        // Timeout para esta tentativa especÃ­fica
        setTimeout(() => {
          if (!respostaRecebida) {
            addLog(`[Site B] â° Timeout na tentativa ${tentativasEnvio}`);
            
            if (tentativasEnvio < maxTentativas) {
              addLog("[Site B] ğŸ”„ Tentando novamente em 3 segundos...");
              setTimeout(() => {
                enviarVerificacao();
              }, 3000);
            } else {
              addLog("[Site B] âŒ Todas as tentativas falharam");
              resultado.innerHTML = `
                <div style="color: orange;">
                  âš ï¸ Sem resposta do Site A apÃ³s ${maxTentativas} tentativas<br>
                  <small>Tente recarregar o iframe ou verificar se hÃ¡ login em outra aba</small>
                </div>
              `;
            }
          }
        }, 8000); // Aumentado para 8 segundos por causa da sincronizaÃ§Ã£o
        
      } catch (error) {
        addLog(`[Site B] âŒ Erro ao enviar mensagem: ${error.message}`);
      }
    }

    // Quando o iframe carregar
    iframe.onload = () => {
      addLog("[Site B] ğŸ“± Iframe carregado");
      addLog(`[Site B] ğŸ”— URL final do iframe: ${iframe.contentWindow?.location?.href || 'nÃ£o acessÃ­vel'}`);
      
      // Reset das variÃ¡veis
      siteAReady = false;
      respostaRecebida = false;
      tentativasEnvio = 0;
      
      // Fallback: se nÃ£o receber siteAReady em 5 segundos, forÃ§a tentativa
      setTimeout(() => {
        if (!siteAReady) {
          addLog("[Site B] â° Timeout aguardando siteAReady, forÃ§ando tentativa...");
          siteAReady = true;
          enviarVerificacao();
        }
      }, 5000);
    };

    // Event listeners dos botÃµes
    document.getElementById("verificarAgain").addEventListener("click", () => {
      addLog("[Site B] ğŸ”„ VerificaÃ§Ã£o manual solicitada");
      tentativasEnvio = 0;
      resultado.innerHTML = "â³ Verificando novamente...";
      enviarVerificacao();
    });

    document.getElementById("reloadIframe").addEventListener("click", () => {
      addLog("[Site B] ğŸ”„ Recarregando iframe do Site A");
      iframe.src = iframe.src;
    });

    // Log quando a pÃ¡gina termina de carregar
    window.addEventListener('load', () => {
      addLog("[Site B] ğŸ“„ PÃ¡gina Site B totalmente carregada");
    });

    // Log de erros gerais
    window.addEventListener('error', (event) => {
      addLog(`[Site B] ğŸ’¥ Erro JavaScript: ${event.message} em ${event.filename}:${event.lineno}`);
    });

    // Log inicial
    addLog("[Site B] âœ… Sistema de logs iniciado");
  </script>
</body>
</html>
