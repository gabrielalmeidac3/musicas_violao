<!DOCTYPE html>
<html>
<head>
  <title>Site B - Verificador</title>
</head>
<body>
  <h1>🔍 Site B - Verificando login do Site A</h1>
  <div id="resultado">⏳ Aguardando autenticação...</div>

  <div style="margin-top: 20px;">
    <button onclick="recarregarIframe()">🔄 Recarregar Site A</button>
    <button onclick="forcarSincronizacao()">⚡ Forçar Sincronização</button>
    <button onclick="abrirEmNovaAba()">🪟 Abrir Site A em Nova Aba</button>
  </div>

  <iframe id="iframeA"
    src="https://viocomg.github.io/cursofechadoviolao/site_a_login_gpt.html"
    style="width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 20px;">
  </iframe>

  <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>

  <script>
    const AUTH_STORAGE_KEY = 'firebase_auth_cross_frame_sync';
    const resultado = document.getElementById('resultado');
    const logs = document.getElementById('logs');
    const iframe = document.getElementById('iframeA');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const full = `[${time}] ${msg}`;
      console.log(full);
      logs.innerHTML += full + '\n';
      logs.scrollTop = logs.scrollHeight;
    }

    function atualizarResultado(uid) {
      if (uid) {
        resultado.textContent = `✅ Usuário autenticado: ${uid}`;
      } else {
        resultado.textContent = "🚫 Usuário deslogado.";
      }
    }

    function recarregarIframe() {
      log("🔁 Recarregando iframe...");
      iframe.src = iframe.src;
    }

    function abrirEmNovaAba() {
      log("🪟 Abrindo Site A em nova aba...");
      window.open(iframe.src, '_blank');
    }

    function forcarSincronizacao() {
      log("⚡ Enviando mensagem de sync forçada para iframe...");
      iframe.contentWindow.postMessage({ type: 'pedir-auth' }, '*');
    }

    // Receber mensagens do iframe
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== 'object') return;

      if (msg.type === 'auth-update') {
        log(`📨 Recebido auth do iframe: ${JSON.stringify(msg)}`);
        atualizarResultado(msg.uid);
      } else if (msg.type === 'auth-logout') {
        log("📨 Recebido logout do iframe");
        atualizarResultado(null);
      }
    });

    // Tentativa inicial de leitura via localStorage (se possível)
    try {
      const auth = localStorage.getItem(AUTH_STORAGE_KEY);
      if (auth) {
        const dados = JSON.parse(auth);
        log(`📦 LocalStorage detectado: ${JSON.stringify(dados)}`);
        atualizarResultado(dados.uid);
      } else {
        log("📦 LocalStorage vazio ou logout detectado");
        atualizarResultado(null);
      }
    } catch (err) {
      log(`⚠️ Erro ao ler localStorage: ${err.message}`);
    }

    // Tentar pedir auth via postMessage
    setTimeout(() => {
      forcarSincronizacao();
    }, 2000);
  </script>
</body>
</html>
