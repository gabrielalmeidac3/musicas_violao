<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé• Gravador de Videochamadas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            background: #333;
            border: 2px solid #555;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        button:hover:not(:disabled) {
            background: #444;
            border-color: #666;
            transform: translateY(-2px);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #222;
            border-color: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        button.recording {
            background: #ff4444;
            border-color: #ff6666;
            animation: pulse 2s infinite;
        }

        button.paused {
            background: #ff8800;
            border-color: #ffaa00;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-panel {
            text-align: center;
            margin-bottom: 30px;
        }

        .status {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            min-height: 1.5em;
        }

        .status.recording {
            color: #ff4444;
        }

        .status.paused {
            color: #ff8800;
        }

        .status.error {
            color: #ff5555;
        }

        .status.success {
            color: #44ff44;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #4ecdc4;
        }

        .audio-config {
            margin-bottom: 30px;
        }

        .audio-config h3 {
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .config-panel {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .config-panel.visible {
            display: block;
        }

        .device-group {
            margin-bottom: 20px;
        }

        .device-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
        }

        select {
            width: 100%;
            padding: 10px;
            background: #222;
            border: 2px solid #555;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }

        select:focus {
            outline: none;
            border-color: #4ecdc4;
        }

        .audio-visualizer {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .viz-container {
            flex: 1;
            background: #222;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .viz-title {
            margin-bottom: 10px;
            font-weight: 600;
            color: #ddd;
        }

        .viz-bars {
            display: flex;
            justify-content: center;
            align-items: end;
            height: 60px;
            gap: 2px;
        }

        .viz-bar {
            width: 4px;
            background: linear-gradient(to top, #4ecdc4, #ff6b6b);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .mic-on {
            background: #333;
            border-color: #4ecdc4;
        }
        .mic-off {
            background: #444;
            border-color: #ff5555;
        }
        .mic-off-visualizer {
            background: #8b0000 !important; /* Vermelho escuro */
        }

        .instructions {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .instructions h3 {
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .compatibility-warning {
            background: #ff5555;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        @media (max-width: 640px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 200px;
            }

            .audio-visualizer {
                flex-direction: column;
            }

            h1 {
                font-size: 1.8em;
            }

            .timer {
                font-size: 1.5em;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Gravador de Videochamadas</h1>
        
        <div id="compatibilityWarning" class="compatibility-warning" style="display: none;">
            ‚ö†Ô∏è Seu navegador n√£o suporta todas as funcionalidades necess√°rias para grava√ß√£o.
        </div>

        <div class="controls">
            <button id="startBtn" aria-label="Iniciar grava√ß√£o de videochamada">
                ‚ñ∂Ô∏è Iniciar Grava√ß√£o
            </button>
            <button id="pauseBtn" disabled aria-label="Pausar grava√ß√£o">
                ‚è∏Ô∏è Pausar
            </button>
            <button id="stopBtn" disabled aria-label="Parar grava√ß√£o">
                ‚èπÔ∏è Parar
            </button>
            <button id="configBtn" aria-label="Abrir configura√ß√µes de √°udio" aria-expanded="false">
                üîä Configura√ß√µes de √Åudio
            </button>
            <button id="micToggleBtn" aria-label="Desativar microfone" class="mic-on">üé§ Microfone Ativado</button>
        </div>

        <div class="status-panel">
            <div id="status" class="status" aria-live="polite" aria-atomic="true">
                Pronto para gravar
            </div>
            <div id="timer" class="timer" aria-live="polite" aria-label="Tempo de grava√ß√£o">
                00:00:00
            </div>
        </div>

        <div class="audio-config">
            <div id="configPanel" class="config-panel" role="region" aria-labelledby="configBtn">
                <div class="device-group">
                    <label for="microphoneSelect">Microfone:</label>
                    <select id="microphoneSelect" aria-label="Selecionar microfone">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                
                <div class="device-group">
                    <select id="audioOutputSelect" aria-label="Selecionar sa√≠da de √°udio">
                        <option value="tab" selected>√Åudio da Guia (Padr√£o)</option>
                        <option value="system">√Åudio do Sistema (Experimental)</option>
                    </select>
                </div>

                <div class="audio-visualizer">
                    <div class="viz-container">
                        <div class="viz-title">Microfone</div>
                        <div id="micViz" class="viz-bars" aria-label="Visualiza√ß√£o do √°udio do microfone"></div>
                    </div>
                    <div class="viz-container">
                        <div class="viz-title">√Åudio da Guia</div>
                        <div id="tabViz" class="viz-bars" aria-label="Visualiza√ß√£o do √°udio da guia"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>üìã Instru√ß√µes:</h3>
            <ul>
                <li>Clique em "Iniciar Grava√ß√£o" e selecione a aba ou tela desejada</li>
                <li>Permite captura de √°udio do sistema + microfone simultaneamente</li>
                <li>Use Pausar/Retomar durante a grava√ß√£o sem perder dados</li>
                <li>Arquivo salvo automaticamente como WebM de alta qualidade</li>
                <li>Nome do arquivo: "dd-mmm-yy-HHMM.webm" (ex: 09-jun-25-1430.webm)</li>
                <li>Fechar a aba salva automaticamente a grava√ß√£o</li>
                <li>Configure dispositivos de √°udio nas "Configura√ß√µes de √Åudio"</li>
            </ul>
        </div>
    </div>

    <script>
        class VideoCallRecorder {
            constructor() {
                
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.displayStream = null;
                this.micStream = null;
                this.combinedStream = null;
                this.audioContext = null;
                this.micAnalyser = null;
                this.tabAnalyser = null;
                this.animationId = null;
                this.timerInterval = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.isRecording = false;
                this.isPaused = false;
                this.isConfigVisible = false;
                this.isMicEnabled = true;

                this.initializeElements();
                this.setupEventListeners();
                this.checkCompatibility();
                this.requestInitialPermissions(); // ADICIONAR ESTA LINHA

                this.loadDevices();
                this.startMicrophoneMonitoring();
                this.setupVisualization();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.configBtn = document.getElementById('configBtn');
                this.status = document.getElementById('status');
                this.timer = document.getElementById('timer');
                this.configPanel = document.getElementById('configPanel');
                this.microphoneSelect = document.getElementById('microphoneSelect');
                this.audioOutputSelect = document.getElementById('audioOutputSelect');
                this.micViz = document.getElementById('micViz');
                this.tabViz = document.getElementById('tabViz');
                this.compatibilityWarning = document.getElementById('compatibilityWarning');

                // Verificar se audioOutputSelect existe
                if (!this.audioOutputSelect) {
                    console.error('Erro: elemento audioOutputSelect n√£o encontrado!');
                }
            }

            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startRecording());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.stopBtn.addEventListener('click', () => this.stopRecording());
                this.configBtn.addEventListener('click', () => this.toggleConfig());
                this.micToggleBtn = document.getElementById('micToggleBtn');
                this.micToggleBtn.addEventListener('click', () => this.toggleMicrophone());
                this.microphoneSelect.addEventListener('change', () => this.updateMicrophone());
                if (this.audioOutputSelect) {
                    this.audioOutputSelect.addEventListener('change', () => this.updateAudioSource());
                } else {
                    console.warn('audioOutputSelect n√£o encontrado, evento n√£o adicionado');
                }


                // Detectar mudan√ßas de dispositivos
                navigator.mediaDevices.addEventListener('devicechange', () => this.loadDevices());

                // Salvar automaticamente ao fechar a aba
                window.addEventListener('beforeunload', (e) => {
                    if (this.isRecording) {
                        e.preventDefault();
                        e.returnValue = 'Grava√ß√£o em andamento. Deseja realmente fechar?';
                    }
                });

                // Suporte a teclado
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                        switch(e.key) {
                            case ' ':
                                e.preventDefault();
                                if (this.isRecording) {
                                    this.togglePause();
                                } else {
                                    this.startRecording();
                                }
                                break;
                            case 'Escape':
                                if (this.isRecording) {
                                    this.stopRecording();
                                }
                                break;
                        }
                    }
                });
            
            
                
            }

            async requestInitialPermissions() {
            try {
                // Solicitar permiss√£o tempor√°ria apenas para listar dispositivos
                const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Parar imediatamente - s√≥ precisamos da permiss√£o
                tempStream.getTracks().forEach(track => track.stop());
            } catch (error) {
                console.log('Permiss√£o de microfone n√£o concedida inicialmente');
            }
        }

            checkCompatibility() {
                const hasMediaRecorder = 'MediaRecorder' in window;
                const hasGetDisplayMedia = navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia;
                const hasGetUserMedia = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

                if (!hasMediaRecorder || !hasGetDisplayMedia || !hasGetUserMedia) {
                    this.compatibilityWarning.style.display = 'block';
                    this.startBtn.disabled = true;
                    this.updateStatus('Navegador incompat√≠vel', 'error');
                    return false;
                }

                return true;
            }

            async loadDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    // Limpar op√ß√µes existentes
                    this.microphoneSelect.innerHTML = '';
                    
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    // Preencher microfones
                    if (audioInputs.length === 0) {
                        this.microphoneSelect.innerHTML = '<option value="">Nenhum microfone encontrado</option>';
                    } else {
                        audioInputs.forEach((device, index) => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = device.label || `Microfone ${index + 1}`;
                            this.microphoneSelect.appendChild(option);
                        });
                        if (!this.microphoneSelect.value) {
                            this.microphoneSelect.value = audioInputs[0].deviceId;
                        }
                    }

                    // Atualizar op√ß√µes de √°udio
                    this.audioOutputSelect.innerHTML = `
                        <option value="tab">√Åudio da Guia</option>
                        <option value="system">√Åudio do Sistema (Loopback)</option>
                    `;

                } catch (error) {
                    console.error('Erro ao carregar dispositivos:', error);
                    this.microphoneSelect.innerHTML = '<option value="">Erro ao carregar dispositivos</option>';
                    this.audioOutputSelect.innerHTML = '<option value="tab">√Åudio da Guia</option>';
                }
            }

            async requestSystemAudio() {
                try {
                    // Solicitar captura de desktop com √°udio do sistema
                    const systemStream = await navigator.mediaDevices.getDisplayMedia({
                        video: false,
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 48000,
                            suppressLocalAudioPlayback: false
                        }
                    });
                    
                    return systemStream;
                } catch (error) {
                    console.error('Erro ao capturar √°udio do sistema:', error);
                    throw error;
                }
            }

            async startMicrophoneMonitoring() {
                if (!this.isMicEnabled) return;

                try {
                    if (!this.micStream) {
                        const constraints = {
                            audio: this.microphoneSelect.value ? 
                                { deviceId: { exact: this.microphoneSelect.value } } : 
                                true
                        };
                        this.micStream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    if (!this.audioContext) {
                        this.audioContext = new AudioContext();
                    }

                    if (!this.micAnalyser) {
                        const micSource = this.audioContext.createMediaStreamSource(this.micStream);
                        this.micAnalyser = this.audioContext.createAnalyser();
                        this.micAnalyser.fftSize = 256;
                        this.micAnalyser.smoothingTimeConstant = 0.3;
                        micSource.connect(this.micAnalyser);
                    }

                    this.startMicVisualization();
                } catch (error) {
                    console.error('Erro ao iniciar monitoramento do microfone:', error);
                }
            }

            setupVisualization() {
                // Criar barras de visualiza√ß√£o
                for (let i = 0; i < 20; i++) {
                    const micBar = document.createElement('div');
                    micBar.className = 'viz-bar';
                    micBar.style.height = '2px';
                    this.micViz.appendChild(micBar);

                    const tabBar = document.createElement('div');
                    tabBar.className = 'viz-bar';
                    tabBar.style.height = '2px';
                    this.tabViz.appendChild(tabBar);
                }
            }

            toggleMicrophone() {
                this.isMicEnabled = !this.isMicEnabled;
                const micVizContainer = this.micViz.parentElement;
                this.micToggleBtn.classList.toggle('mic-on', this.isMicEnabled);
                this.micToggleBtn.classList.toggle('mic-off', !this.isMicEnabled);
                this.micToggleBtn.setAttribute('aria-label', this.isMicEnabled ? 'Desativar microfone' : 'Ativar microfone');
                this.micToggleBtn.textContent = this.isMicEnabled ? 'üé§ Microfone Ativado' : 'üé§ Microfone Desativado';
                micVizContainer.classList.toggle('mic-off-visualizer', !this.isMicEnabled);

                if (!this.isMicEnabled) {
                    if (this.micStream) {
                        this.micStream.getAudioTracks().forEach(track => track.enabled = false);
                    }
                } else {
                    if (this.micStream) {
                        this.micStream.getAudioTracks().forEach(track => track.enabled = true);
                    } else {
                        this.startMicrophoneMonitoring();
                    }
                }
            }

            toggleConfig() {
                this.isConfigVisible = !this.isConfigVisible;
                this.configPanel.classList.toggle('visible', this.isConfigVisible);
                this.configBtn.setAttribute('aria-expanded', this.isConfigVisible.toString());
            }
            
            showAudioWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #ff5555; color: white; padding: 15px; 
                border-radius: 8px; z-index: 1000; max-width: 300px;
                font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            warningDiv.innerHTML = `
                ‚ö†Ô∏è IMPORTANTE:<br>
                Certifique-se de marcar<br>
                "Compartilhar √°udio da guia"<br>
                na janela de sele√ß√£o!
            `;
            document.body.appendChild(warningDiv);
            
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.parentNode.removeChild(warningDiv);
                }
            }, 2000);
        }

            async startRecording() {
                try {
                    this.updateStatus('Solicitando permiss√µes...', 'recording');
                    
                    // Adicione esta linha antes de solicitar captura de tela
                    this.showAudioWarning();

                    // Solicitar captura de tela com configura√ß√µes mais espec√≠ficas
                    this.displayStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            mediaSource: 'screen',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 48000
                        }
                    });

                    // Exibir mensagem se dispositivo de sa√≠da foi selecionado
                    if (this.audioOutputSelect && this.audioOutputSelect.value && this.audioOutputSelect.value !== 'tab' && this.audioOutputSelect.value !== 'system') {
                        console.log('Dispositivo de sa√≠da selecionado:', this.audioOutputSelect.value);
                        this.updateStatus('Aviso: √Åudio do sistema ser√° capturado experimentalmente', 'success');
                    }

                    // Verificar se o √°udio da guia foi capturado
                    const hasTabAudio = this.displayStream.getAudioTracks().length > 0;
                    if (!hasTabAudio) {
                        console.warn('‚ö†Ô∏è √Åudio da guia n√£o foi capturado. Certifique-se de marcar "Compartilhar √°udio da guia" na janela de sele√ß√£o.');
                        this.updateStatus('Aten√ß√£o: √Åudio da guia n√£o detectado', 'error');
                    }

                    // Solicitar microfone
                    const micConstraints = {
                        audio: this.microphoneSelect.value ? 
                            { deviceId: { exact: this.microphoneSelect.value } } : 
                            true
                    };
                    
                    this.micStream = await navigator.mediaDevices.getUserMedia(micConstraints);

                    // Combinar streams
                    await this.combineStreams();
                    
                    this.startTabVisualization();

                    // Configurar MediaRecorder
                    const options = {
                        mimeType: 'video/webm;codecs=vp8,opus',
                        videoBitsPerSecond: 2500000,
                        audioBitsPerSecond: 128000
                    };

                    this.mediaRecorder = new MediaRecorder(this.combinedStream, options);
                    this.recordedChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.saveRecording();
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('Erro no MediaRecorder:', event.error);
                        this.updateStatus('Erro na grava√ß√£o', 'error');
                    };

                    // Iniciar grava√ß√£o
                    this.mediaRecorder.start(1000); // Chunks de 1 segundo
                    
                    this.isRecording = true;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.pausedTime = 0;
                    
                    this.updateUI();
                    this.startTimer();
                    this.startVisualization();
                    
                    this.updateStatus('GRAVANDO', 'recording');

                    // Detectar quando o usu√°rio para de compartilhar
                    this.displayStream.getVideoTracks()[0].addEventListener('ended', () => {
                        if (this.isRecording) {
                            this.stopRecording();
                        }
                    });

                } catch (error) {
                    console.error('Erro ao iniciar grava√ß√£o:', error);
                    this.handleRecordingError(error);
                }
            }

            async combineStreams() {
                if (this.audioContext) {
                    await this.audioContext.close();
                }
                this.audioContext = new AudioContext();
                const destination = this.audioContext.createMediaStreamDestination();
                const audioSource = this.audioOutputSelect ? this.audioOutputSelect.value : 'tab';

                console.log('=== DEBUG COMBINE STREAMS ===');
                console.log('Fonte de √°udio selecionada:', audioSource);
                console.log('micStream existe:', !!this.micStream);
                console.log('micStream tracks:', this.micStream?.getAudioTracks().length || 0);
                console.log('displayStream tracks:', this.displayStream?.getAudioTracks().length || 0);

                // Configurar microfone se ativado
                if (this.isMicEnabled && this.microphoneSelect.value) {
                    console.log('Configurando microfone...');
                    try {
                        if (!this.micStream || !this.micStream.getAudioTracks().length) {
                            const constraints = {
                                audio: { deviceId: { exact: this.microphoneSelect.value } }
                            };
                            this.micStream = await navigator.mediaDevices.getUserMedia(constraints);
                        }
                        const micSource = this.audioContext.createMediaStreamSource(this.micStream);
                        this.micAnalyser = this.audioContext.createAnalyser();
                        this.micAnalyser.fftSize = 256;
                        this.micAnalyser.smoothingTimeConstant = 0.3;
                        micSource.connect(this.micAnalyser);
                        micSource.connect(destination);
                        console.log('Microfone conectado ao destino!');
                    } catch (error) {
                        console.warn('Erro ao configurar microfone:', error);
                    }
                } else {
                    console.warn('Microfone desativado ou sem dispositivo selecionado');
                }

                // Configurar √°udio da guia ou sistema
                if (this.displayStream && this.displayStream.getAudioTracks().length > 0 && audioSource !== 'mic') {
                    console.log('Configurando √°udio da guia/sistema...');
                    const displaySource = this.audioContext.createMediaStreamSource(this.displayStream);
                    this.tabAnalyser = this.audioContext.createAnalyser();
                    this.tabAnalyser.fftSize = 256;
                    this.tabAnalyser.smoothingTimeConstant = 0.3;
                    displaySource.connect(this.tabAnalyser);
                    displaySource.connect(destination);
                    console.log('√Åudio da guia/sistema conectado ao destino!');
                }

                // Combinar v√≠deo e √°udio
                const videoTrack = this.displayStream.getVideoTracks()[0];
                const audioTracks = destination.stream.getAudioTracks();
                this.combinedStream = new MediaStream([videoTrack, ...audioTracks]);
                console.log('Stream combinado criado com', audioTracks.length, 'faixas de √°udio');

                
                // Reconfigurar MediaRecorder se necess√°rio
                if (this.isRecording && this.mediaRecorder) {
                    const wasPaused = this.isPaused;
                    if (!wasPaused) this.togglePause();
                    
                    // Parar o MediaRecorder atual, mas n√£o acionar onstop
                    if (this.mediaRecorder.state !== 'inactive') {
                        this.mediaRecorder.stop();
                    }
                    
                    // Aguardar a coleta dos chunks pendentes
                    await new Promise(resolve => {
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this.recordedChunks.push(event.data);
                            }
                            resolve();
                        };
                    });

                    // Criar novo MediaRecorder
                    this.mediaRecorder = new MediaRecorder(this.combinedStream, {
                        mimeType: 'video/webm;codecs=vp8,opus',
                        videoBitsPerSecond: 2500000,
                        audioBitsPerSecond: 128000
                    });

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };
                    this.mediaRecorder.onstop = () => this.saveRecording();
                    this.mediaRecorder.onerror = (event) => {
                        console.error('Erro no MediaRecorder:', event.error);
                        this.updateStatus('Erro na grava√ß√£o', 'error');
                    };

                    this.mediaRecorder.start(1000);
                    if (!wasPaused) this.togglePause();
                }
            }

            togglePause() {
                if (!this.isRecording) return;

                if (this.isPaused) {
                    // Retomar
                    this.mediaRecorder.resume();
                    this.isPaused = false;
                    this.startTime = Date.now() - this.pausedTime;
                    this.updateStatus('GRAVANDO', 'recording');
                    this.pauseBtn.textContent = '‚è∏Ô∏è Pausar';
                    this.pauseBtn.setAttribute('aria-label', 'Pausar grava√ß√£o');
                } else {
                    // Pausar
                    this.mediaRecorder.pause();
                    this.isPaused = true;
                    this.pausedTime = Date.now() - this.startTime;
                    this.updateStatus('PAUSADO', 'paused');
                    this.pauseBtn.textContent = '‚ñ∂Ô∏è Retomar';
                    this.pauseBtn.setAttribute('aria-label', 'Retomar grava√ß√£o');
                }

                this.updateUI();
            }

            stopRecording() {
                if (!this.isRecording) return;

                this.isRecording = false;
                this.isPaused = false;

                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }

                this.cleanup();
                this.updateUI();
                this.updateStatus('Processando...', 'success');
            }

            cleanup() {
                // Parar timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }

                // Parar visualiza√ß√£o
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }

                // Fechar streams
                if (this.displayStream) {
                    this.displayStream.getTracks().forEach(track => track.stop());
                    this.displayStream = null;
                }
                
                // Manter micStream e audioContext ativos para visualiza√ß√£o cont√≠nua
                if (this.micStream && !this.micStream.getTracks().some(track => track.readyState === 'live')) {
                    this.micStream = null;
                    this.micAnalyser = null;
                    // Reiniciar monitoramento do microfone
                    this.startMicrophoneMonitoring();
                }
                

                if (this.combinedStream) {
                    this.combinedStream.getTracks().forEach(track => track.stop());
                    this.combinedStream = null;
                }

                if (this.displayStream && this.displayStream.getAudioTracks().length > 0) {
                    this.startTabVisualization();
                }
            }

            saveRecording() {
                if (this.recordedChunks.length === 0) {
                    this.updateStatus('Erro: Grava√ß√£o vazia', 'error');
                    return;
                }

                const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const filename = this.generateFilename(now);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Limpar URL
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                this.updateStatus(`Salvo: ${filename}`, 'success');
                this.recordedChunks = [];
            }

            generateFilename(date) {
                const months = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun',
                              'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = months[date.getMonth()];
                const year = date.getFullYear().toString().slice(-2);
                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');
                
                return `${day}-${month}-${year}-${hour}${minute}.webm`;
            }

            updateUI() {
                this.startBtn.disabled = this.isRecording;
                this.pauseBtn.disabled = !this.isRecording;
                this.stopBtn.disabled = !this.isRecording;

                // Atualizar classes dos bot√µes
                this.startBtn.classList.toggle('recording', this.isRecording && !this.isPaused);
                this.pauseBtn.classList.toggle('paused', this.isPaused);

                // Atualizar ARIA
                this.startBtn.setAttribute('aria-disabled', this.isRecording.toString());
                this.pauseBtn.setAttribute('aria-disabled', (!this.isRecording).toString());
                this.stopBtn.setAttribute('aria-disabled', (!this.isRecording).toString());
            }

            updateStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = this.isPaused ? 
                        this.pausedTime : 
                        Date.now() - this.startTime;
                    
                    const seconds = Math.floor(elapsed / 1000);
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    this.timer.textContent = timeString;
                }, 1000);
            }

            startVisualization() {
                const updateViz = () => {
                    if (!this.isRecording) return;

                    // Visualiza√ß√£o do microfone
                    if (this.micAnalyser) {
                        const micData = new Uint8Array(this.micAnalyser.frequencyBinCount);
                        this.micAnalyser.getByteFrequencyData(micData);
                        
                        // Debug melhorado
                        const micSum = micData.reduce((a, b) => a + b, 0);
                        const micMax = Math.max(...micData);
                        //console.log('Mic - Soma:', micSum, 'M√°ximo:', micMax, 'Primeiro valor:', micData[0]);
                        
                        this.updateVisualizationBars(this.micViz, micData);
                    } else {
                        console.log('micAnalyser n√£o existe!');
                    }

                    // Visualiza√ß√£o do √°udio da guia
                    if (this.tabAnalyser) {
                        const tabData = new Uint8Array(this.tabAnalyser.frequencyBinCount);
                        this.tabAnalyser.getByteFrequencyData(tabData);
                        
                        const tabSum = tabData.reduce((a, b) => a + b, 0);
                        const tabMax = Math.max(...tabData);
                        //console.log('Tab - Soma:', tabSum, 'M√°ximo:', tabMax);
                        
                        this.updateVisualizationBars(this.tabViz, tabData);
                    }

                    this.animationId = requestAnimationFrame(updateViz);
                };

                updateViz();
            }

            startMicVisualization() {
                const updateMicViz = () => {
                    if (this.micAnalyser) {
                        const micData = new Uint8Array(this.micAnalyser.frequencyBinCount);
                        this.micAnalyser.getByteFrequencyData(micData);
                        this.updateVisualizationBars(this.micViz, micData);
                    }
                    
                    this.micAnimationId = requestAnimationFrame(updateMicViz);
                };
                
                updateMicViz();
            }

            startTabVisualization() {
                const updateTabViz = () => {
                    if (this.tabAnalyser) {
                        const tabData = new Uint8Array(this.tabAnalyser.frequencyBinCount);
                        this.tabAnalyser.getByteFrequencyData(tabData);
                        this.updateVisualizationBars(this.tabViz, tabData);
                    }
                    this.tabAnimationId = requestAnimationFrame(updateTabViz);
                };
                updateTabViz();
            }

            updateVisualizationBars(container, data) {
                const bars = container.children;
                const step = Math.floor(data.length / bars.length);
                
                for (let i = 0; i < bars.length; i++) {
                    const value = data[i * step] || 0;
                    const height = Math.max(2, (value / 255) * 60);
                    bars[i].style.height = `${height}px`;
                    // Adicionar opacidade baseada na atividade
                    bars[i].style.opacity = value > 10 ? '1' : '0.3';
                }
            }

            async updateMicrophone() {
                if (!this.isRecording) return;

                try {
                    // Pausar grava√ß√£o temporariamente
                    const wasPaused = this.isPaused;
                    if (!wasPaused) {
                        this.togglePause();
                    }

                    // Parar stream atual do microfone
                    if (this.micStream) {
                        this.micStream.getTracks().forEach(track => track.stop());
                    }

                    // Criar novo stream
                    const constraints = {
                        audio: this.microphoneSelect.value ? 
                            { deviceId: { exact: this.microphoneSelect.value } } : 
                            true
                    };
                    
                    this.micStream = await navigator.mediaDevices.getUserMedia(constraints);

                    this.startMicrophoneMonitoring();

                    // Reconectar √°udio
                    await this.combineStreams();
                    
                    // Retomar se n√£o estava pausado
                    if (!wasPaused) {
                        this.togglePause();
                    }

                } catch (error) {
                    console.error('Erro ao trocar microfone:', error);
                    this.updateStatus('Erro ao trocar microfone', 'error');
                }
            }

            async updateAudioSource() {
                if (!this.isRecording) return;
                
                console.log('Sa√≠da de √°udio alterada:', this.audioOutputSelect.value);
                
                const selectedValue = this.audioOutputSelect.value;
                
                try {
                    // Se for um dispositivo de sa√≠da, apenas informar que ser√° aplicado na pr√≥xima grava√ß√£o
                    if (selectedValue !== 'tab' && selectedValue !== 'mic' && selectedValue !== 'both') {
                        await this.updateSystemAudio();
                        this.updateStatus('Sa√≠da de √°udio do sistema selecionada', 'success');
                        return;
}

                    // Pausar grava√ß√£o temporariamente
                    const wasPaused = this.isPaused;
                    if (!wasPaused) {
                        this.togglePause();
                    }

                    // Parar stream atual da tela
                    if (this.displayStream) {
                        this.displayStream.getTracks().forEach(track => track.stop());
                        this.displayStream = null;
                    }

                    // Solicitar novo displayStream com configura√ß√µes padr√£o
                    this.displayStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            mediaSource: 'screen',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 48000
                        }
                    });

                    // Verificar se o √°udio da guia foi capturado
                    const hasTabAudio = this.displayStream.getAudioTracks().length > 0;
                    if (!hasTabAudio) {
                        console.warn('‚ö†Ô∏è √Åudio da guia n√£o foi capturado.');
                        this.updateStatus('Aten√ß√£o: √Åudio da guia n√£o detectado', 'error');
                    }

                    // Reconectar streams
                    await this.combineStreams();
                    this.startTabVisualization();

                    // Retomar se n√£o estava pausado
                    if (!wasPaused) {
                        this.togglePause();
                    }

                    this.updateStatus('Sa√≠da de √°udio alterada com sucesso', 'success');
                } catch (error) {
                    console.error('Erro ao alterar sa√≠da de √°udio:', error);
                    this.updateStatus('Erro ao alterar sa√≠da de √°udio', 'error');
                }
            }

            async updateSystemAudio() {
                try {
                    if (this.displayStream) {
                        this.displayStream.getTracks().forEach(track => track.stop());
                    }
                    this.displayStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' },
                        audio: true
                    });
                    await this.combineStreams();
                    this.startTabVisualization();
                    this.updateStatus('Sa√≠da de √°udio do sistema atualizada', 'success');
                } catch (error) {
                    console.error('Erro ao atualizar √°udio do sistema:', error);
                    this.updateStatus('Erro ao mudar sa√≠da de √°udio', 'error');
                }
            }

            handleRecordingError(error) {
                let message = 'Erro ao iniciar grava√ß√£o';
                
                if (error.name === 'NotAllowedError') {
                    message = 'Permiss√£o negada para captura de tela/√°udio';
                } else if (error.name === 'NotFoundError') {
                    message = 'Dispositivo de √°udio n√£o encontrado';
                } else if (error.name === 'NotSupportedError') {
                    message = 'Grava√ß√£o n√£o suportada neste navegador';
                }
                
                this.updateStatus(message, 'error');
                this.cleanup();
                this.updateUI();
            }
        }

        // Inicializar aplica√ß√£o quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            new VideoCallRecorder();
        });
    </script>
</body>
</html>
