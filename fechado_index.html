<!DOCTYPE html>
<html lang="pt-BR">
<!--teste-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso de Violão do Zero ao Repertório</title>
    <link rel="stylesheet" href="fechado_styles.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>



<body>
    <div id="loading">Carregando Curso <br>Do Zero ao Repertório</div>
    <div id="content"></div>
    <div class="logout-button" onclick="logout()">Sair</div>

    <script>
        // Declarar auth e db globalmente
        let auth = null;
        let db = null;
    
        // Inicializar Firebase apenas se ainda não foi inicializado
        if (!firebase.apps.length) {
            fetch('https://broken-silence-aaa9.2gabrielekaline.workers.dev')
                .then(response => response.json())
                .then(firebaseConfig => {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase inicializado com configuração segura!');
                    loadContent();
                })
                .catch(error => console.error('Erro ao carregar configuração do Firebase:', error));
        } else {
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase já inicializado.');
            loadContent();
        }
    
        function loadContent() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    const telefone = user.email.split('@')[0];
                    db.collection('alunos').where('telefone', '==', telefone).get()
                        .then((snapshot) => {
                            if (!snapshot.empty && snapshot.docs[0].data().acesso === 'Liberado') {
                                fetch('fechado_curso.html').then(response => response.text()).then(data => {
                                    document.getElementById('content').innerHTML = data;
                                    const urlParams = new URLSearchParams(window.location.search);
                                    const from = urlParams.get('from');
                                    window.voltarPaginaGeral = function() {
                                        window.location.href = from === 'geral2' ? 'fechado_geral2.html' : 'fechado_geral_protegido_site.html';
                                    };
                                    document.getElementById('loading').style.display = 'none';
                                }).catch(error => console.error('Erro ao carregar conteúdo:', error));
                            } else {
                                alert('Acesso negado.');
                                auth.signOut();
                                const urlParams = new URLSearchParams(window.location.search);
                                const from = urlParams.get('from');
                                window.location.href = `fechado_geral_protegido.html${from ? '?from=' + from : ''}`;
                            }
                        })
                        .catch(error => console.error('Erro ao verificar aluno:', error));
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    const from = urlParams.get('from');
                    window.location.href = `fechado_geral_protegido.html${from ? '?from=' + from : ''}`;
                }
            });
        }
    
        function loadVideo(element) {
            const src = element.getAttribute('data-src');
            element.innerHTML = `<iframe src="${src}?autoplay=1&rel=0&showinfo=0&iv_load_policy=3&modestbranding=1" frameborder="0" allowfullscreen></iframe>`;
        }

        function toggleSection(element) {
            const content = element.nextElementSibling;
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            element.textContent = isOpen ? 'Procurar aulas' : 'Procurar aulas (fechar)';
        }
        
        function toggleNivel() {
            const content = document.getElementById("nivelContent");
            const toggleBtn = document.querySelector(".toggle-nivel");
            const aberto = content.style.display === "block";
            content.style.display = aberto ? "none" : "block";
            toggleBtn.textContent = aberto
                ? "Veja em qual nível de violão você está"
                : "Veja em qual nível de violão você está (fechar)";
        }
        
        function toggleSongList(element) {
            const list = element.nextElementSibling;
            const isOpen = list.style.display === 'block';
            list.style.display = isOpen ? 'none' : 'block';
            element.style.color = isOpen ? 'white' : 'rgb(255, 188, 188)';
            element.textContent = isOpen ? element.getAttribute('data-original-text') : 'Fechar lista';
        }
        
        function scrollToLesson(lessonNumber) {
            const lesson = document.getElementById(`lesson-${lessonNumber}`);
            if (lesson) {
                lesson.scrollIntoView({ behavior: 'smooth' });
                const wrapper = lesson.querySelector('.video-wrapper');
                if (wrapper) loadVideo(wrapper);
            }
        }
        
        function toggleDescription(element) {
            const description = element.nextElementSibling;
            description.style.display = description.style.display === 'block' ? 'none' : 'block';
            element.textContent = description.style.display === 'block' ? 'Ocultar descrição' : 'Mostrar descrição';
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'fechado_geral_protegido.html';
            }).catch((error) => {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao sair. Tente novamente.');
            });
        }
    </script>
    <style>
     
        #loading {
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-family: Arial, sans-serif;
            color: #999999;
        }
    </style>

    
</body>

</html>

